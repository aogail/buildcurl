#!/bin/bash

contains_element() {
	local e
	for e in "${@:2}"; do [[ "$e" == "$1" ]] && return 0; done
	return 1
}

DOCKER_ORG=${DOCKER_ORG:=buildcurl}
SOURCE=${SOURCE:="/opt/buildcurl"}
ALLOWED_TARGETS=(
	el:6
	el:7
	debian:7
	debian:8
	ubuntu:12.04
	ubuntu:14.04
	fedora:20
	sles:11
	sles:12
)
TARGET="$1"
RECIPE="$2"

if ! contains_element "$TARGET" "${ALLOWED_TARGETS[@]}" ; then
	echo "Unknown target: '${TARGET}'. Aborting"
	exit 2
fi

if [ -z "$RECIPE" ]; then
	echo "No recipe given. Aborting"
	exit 2
fi

if ! test -f $SOURCE/recipes/$RECIPE ; then
	echo "Unknown recipe: '$RECIPE'. Aborting"
	exit 2
fi

if [ -z "$PREFIX" ]; then
	PREFIX=/usr/local
fi

MAX_CPUS=$(getconf _NPROCESSORS_ONLN)

exec docker run -a stdout -a stderr \
	-e JOBS="$MAX_CPUS" \
	-e PREFIX="$PREFIX" \
	-e LOGGER="$LOGGER" \
       	-e SOURCE=/buildcurl \
	-e VERSION="$VERSION" \
	-e BUILDCURL_URL="$BUILDCURL_URL" \
	-v $SOURCE:/buildcurl:ro \
	-w /tmp \
	"$DOCKER_ORG/$TARGET" \
	/buildcurl/bin/compile "$RECIPE"
